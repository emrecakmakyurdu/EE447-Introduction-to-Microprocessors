;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;				  MAIN OF THE Q3				  ;
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;

PB_INP				EQU		0X4000503C
PB_OUT				EQU		0X400053C0
	
;LABEL			DIRECTIVE	VALUE				COMMENT	
				AREA main,	CODE,	READONLY,	ALIGN=2
				THUMB
					
				;IMPORT		InitSysTick
				IMPORT		PORTB_Init
				IMPORT 		DELAY100
				EXPORT		__main

			
__main			PROC
				;BL			InitSysTick
				BL			PORTB_Init
				MOV			R5,#2				;IF R5 = 1 CW, R5 = 2 CCW, FIRST AND SECOND BUTTON CAN BE USED TO CHANGE THE DIRECTION
												;IF ITS UNWANTED, R5 CAN BE CHANGED TO #2 IN ORDER TO SEE THE CCW ACTION.
				
LOOP			LDR			R0,=PB_INP			;PORTB_DATA REGISTERININ ADRESINI R0'YA KAYDEDIYORUM
				LDRB		R1,[R0]				;PORTB_DATA REGISTERINDEKI DEGERI R1'E KAYDEDIYORUM
				BL			DELAY100			;100MSEC BEKLIYORUM
				LDRB		R2,[R0]				;PORTB_DATA REGISTERINDEKI DEGERI R2'YE KAYDEDIYORUM
				CMP			R1,R2				;DEBOUNCING ICIN KARSILASTIRMA YAPIYORUM
				BNE			LOOP				;DEGILSE YANLISLIK OLMUS, TEKRAR INPUT ALIYORUM
				CMP			R1,#0X00			;R1 VE R2 AYNI OLMASINA RAGMEN 0X00 ISELER, HICBIR TUSA BASILMAMIS DEMEKTIR, TEKRAR INPUT ALIYORUM
				BEQ			LOOP		
				CPY			R4,R1
RELEASE			LDRB		R1,[R0]				;PORTB_DATA'DA SAKLANAN DEGERI R1'E YUKLUYORUM
				BL			DELAY100
				LDRB		R2,[R0]				;PORTB_DATA'DA SAKLANAN DEGERI R2'YE YUKLUYORUM
				CMP			R1,R2				;DEBOUNCING
				BNE			RELEASE
				CMP			R1,#0X00			;EGER HALA TUSA BASILI ISE BIRAKANA KADAR BEKLIYORUM, RELEASE'YE DONUYORUM
				BNE			RELEASE				;EGER TUS BIRAKILDIYSA, R1'E 0XF0 YUKLENIYOR VE BU LOOP'TAN CIKILIYOR
				CPYEQ		R5,R4				;
				
				CMP		R5,#1
				BNE		CCW
				
CW				LDR		R1,=PB_OUT				;IF THE CW IS SELECTED
				LDR		R0,[R1]					;CURRENT STEP IS LOADED TO R0
				LSL		R0,#1					;R0 IS SHIFTED LEFT TO MOVE ON TO THE NEXT STEP
				CMP		R0,#0X100				;IF WE EXCEEDED THE STEP 4
				MOVEQ	R0,#0X10				;MOVE TO STEP 1
				STR		R0,[R1]					;STORE IT
				B		EXIT
				
CCW				LDR		R1,=PB_OUT				;IF THE CCW IS SELECTED
				LDR		R0,[R1]					;CURRENT STEP IS LOADED TO R0
				LSR		R0,#1					;R0 IS SHIFTED RIGHT TO MOVE ON TO THE PREVIOUS STEP
				CMP		R0,#0X08				;IF WE GO BELOW THE STEP 1
				MOVEQ	R0,#0X80				;MOVE TO STEP 4
				STR		R0,[R1]					;STORE IT				
				
EXIT			B			LOOP
				
	
	
				ENDP
					
					
					
					
				END